<h2>{{ study.title }}</h2>

You have enrolled in {{ study.title }}.
<ul>
    <li> <a href="{% url 'study_detail' study.id %}">See the Study Page</a> </li>
    <li>
        <a href="{% url 'withdraw_from_study' study.id %}">Withdraw from the study.</a>
    </li>
</ul>

{% for item in data.incomplete_sources %}
<div>
    <h3> Setup Required for {{ item.source.display_type }} </h3>

    After following the setup instructions, <a href="{{ item.source.get_confirm_url }}">Click here to check for data</a>

    {% if forloop.first %}
        {% include instructions_template %}
    {% else %}
        {% include "studies/consent_action.html" with consent=item.consent study=study source=item.source %}
    {% endif %}
</div>
{% endfor %}

{% for item in data.incomplete_consents %}
<div>
    <h3>Consent Required for {{ item.type_name }}</h3>
    <a href="{% url 'consent_workflow' study.id %}?consent_id={{ item.consent.id }}">
        <button>Continue Consent Workflow</button>
    </a>
</div>
{% endfor %}

{% if data.active_consents %}
    <div>
        <h3>Completed Required Data Sources for {{ study.title }}</h3>
        <ul>
        {% for consent in data.active_consents %}
            <li>
                {{ consent.source.display_type }}:
                {% if consent.source.status == 'active' %}
                    <span style="color: green;">Linked.</span>
                    </br>This data source is set up and actively sending data.
                {% elif consent.source.status == 'pending' %}
                    <span style="color: orange;">Pending Setup.</span>
                    </br>Setup is required for this data source.
                    {% if consent.source.get_setup_url %}
                        <a href="{{ consent.source.get_setup_url }}?consent_id={{ consent.consent.id }}" style="color: blue; text-decoration: underline; margin-left: 10px;">
                            Go to Setup/OAuth
                        </a>
                        {% if consent.source.display_type == "Google Portability Data" %}
                            <div style="font-size:90%; margin-top:6px; color:#333; max-width:40rem;">
                                The use of information received from the Data Portability API adheres to the Data Portability API user data and developer policy, including the Limited Use Requirements.
                            </div>
                        {% endif %}
                    {% endif %}
                {% elif consent.source.status == 'processing' %}
                    <span style="color: blue;">Processing.</span>
                    </br>Data source is being processed.
                {% else %}
                    <span style="color: red;">Inactive.</span>
                    </br>Data source is not yet active.
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    </div>
{% endif %}

{% if data.optional_consents %}
    <div>
        <h3>Optional Data Sources for {{ study.title }}</h3>
        <ul>
        {% for opt_item in data.optional_consents %}
            {% if opt_item.consent.is_complete and opt_item.source %}
                <li>
                    {{ opt_item.type_name }}:
                    {% if opt_item.source.status == 'active' %}
                        <span style="color: green;">Linked.</span>
                        <a href="{% url 'revoke_consent' opt_item.consent.id %}" style="color: red; margin-left: 10px;">
                            (Revoke)
                        </a>
                        </br>This data source is set up and actively sending data.
                    {% elif opt_item.source.status == 'pending' %}
                        <span style="color: orange;">Pending Setup.</span>
                        </br>Setup is required for this data source.
                    {% elif opt_item.source.status == 'processing' %}
                        <span style="color: blue;">Processing.</span>
                        </br>Data source is being processed.
                    {% else %}
                        <span style="color: red;">Inactive.</span>
                        </br>Data source is not yet active.
                    {% endif %}
                </li>
            {% else %}
                <li>
                    Setup {{ opt_item.type_name }}: 
                    <a href="{% url 'consent_workflow' study.id %}?consent_id={{ opt_item.consent.id }}">here</a>
                </li>
            {% endif %}
        {% endfor %}
        </ul>
    </div>
{% endif %}
